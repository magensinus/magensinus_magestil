define(["./core","./var/isFunction","./var/slice","./callbacks"],function(s,d,a){"use strict";function h(e){return e}function p(e){throw e}function l(e,n,t,r){var o;try{e&&d(o=e.promise)?o.call(e).done(n).fail(t):e&&d(o=e.then)?o.call(e,n,t):n.apply(undefined,[e].slice(r))}catch(e){t.apply(undefined,[e])}}return s.extend({Deferred:function(e){var i=[["notify","progress",s.Callbacks("memory"),s.Callbacks("memory"),2],["resolve","done",s.Callbacks("once memory"),s.Callbacks("once memory"),0,"resolved"],["reject","fail",s.Callbacks("once memory"),s.Callbacks("once memory"),1,"rejected"]],o="pending",c={state:function(){return o},always:function(){return a.done(arguments).fail(arguments),this},"catch":function(e){return c.then(null,e)},pipe:function(){var o=arguments;return s.Deferred(function(r){s.each(i,function(e,n){var t=d(o[n[4]])&&o[n[4]];a[n[1]](function(){var e=t&&t.apply(this,arguments);e&&d(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[n[0]+"With"](this,t?[e]:arguments)})}),o=null}).promise()},then:function(n,t,r){function f(i,c,a,l){return function(){var t=this,r=arguments,n=function(){var e,n;if(!(i<u)){if((e=a.apply(t,r))===c.promise())throw new TypeError("Thenable self-resolution");n=e&&("object"==typeof e||"function"==typeof e)&&e.then,d(n)?l?n.call(e,f(u,c,h,l),f(u,c,p,l)):(u++,n.call(e,f(u,c,h,l),f(u,c,p,l),f(u,c,h,c.notifyWith))):(a!==h&&(t=undefined,r=[e]),(l||c.resolveWith)(t,r))}},o=l?n:function(){try{n()}catch(e){s.Deferred.exceptionHook&&s.Deferred.exceptionHook(e,o.stackTrace),u<=i+1&&(a!==p&&(t=undefined,r=[e]),c.rejectWith(t,r))}};i?o():(s.Deferred.getStackHook&&(o.stackTrace=s.Deferred.getStackHook()),window.setTimeout(o))}}var u=0;return s.Deferred(function(e){i[0][3].add(f(0,e,d(r)?r:h,e.notifyWith)),i[1][3].add(f(0,e,d(n)?n:h)),i[2][3].add(f(0,e,d(t)?t:p))}).promise()},promise:function(e){return null!=e?s.extend(e,c):c}},a={};return s.each(i,function(e,n){var t=n[2],r=n[5];c[n[1]]=t.add,r&&t.add(function(){o=r},i[3-e][2].disable,i[3-e][3].disable,i[0][2].lock,i[0][3].lock),t.add(n[3].fire),a[n[0]]=function(){return a[n[0]+"With"](this===a?undefined:this,arguments),this},a[n[0]+"With"]=t.fireWith}),c.promise(a),e&&e.call(a,a),a},when:function(e){var t=arguments.length,n=t,r=Array(n),o=a.call(arguments),i=s.Deferred(),c=function(n){return function(e){r[n]=this,o[n]=1<arguments.length?a.call(arguments):e,--t||i.resolveWith(r,o)}};if(t<=1&&(l(e,i.done(c(n)).resolve,i.reject,!t),"pending"===i.state()||d(o[n]&&o[n].then)))return i.then();for(;n--;)l(o[n],c(n),i.reject);return i.promise()}}),s});